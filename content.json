{"pages":[{"title":"about","text":"","link":"/about/index.html"},{"title":"categories","text":"","link":"/categories/index.html"},{"title":"tags","text":"","link":"/tags/index.html"}],"posts":[{"title":"透過 Elasticsearch 提供 Ceph RGW Metadata 搜尋","text":"使用 Object Storage 一陣子以後，或許你會發現儲存的檔案愈多要找檔案愈麻煩。因此 Ceph 在 K(Kraken) 版以後有提供一個 sync module 可以將資料同步到 Elasticsearch，方便使用者或管理人員利用 query 語法快速找到你想要搜尋檔案的 metadata。 ElasticsearchElasticsearch 是基於 Lucene 的分散式全文搜尋引擎，並在 Apache 許可證下作為開源軟體發佈。現今廣泛用於資料探勘領域，與 Logstash (數據收集與日誌解析引擎) 和 Kibana (數據可視覺化平台) 合稱 ELK。 環境 參數 數值 Operating System Ubuntu 16.04 LTS Ceph Cluster IP 192.168.1.226 RGW1 192.168.1.226:8001 RGW2 192.168.1.226:8002 Realm Name test-realm Zonegroup Name test-zonegroup Zone1 test-zone-1 Zone2 test-zone-2 Elasticsearch Version 5.6+, &lt; 6.0 Elasticsearch IP 192.168.1.226:9200 筆者在 Elasticsearch 這邊卡蠻久的，安裝了 6.6.x 版本以上都無法正常提供服務，後來降到 5.6.x 服務就正常了。看了 Ceph source codes 內似乎有註明 v5，若有其他大大們知道原因也可以底下留言如何解決 6.6.x 無法正常提供服務的方法。 架構實作時需要建立至少兩個 Zone，一個是提供使用者利用 s3 potocal 透過 Radosgw 對 Ceph Object Storage 進行操作，另一個 Zone 是同步數據使用，並將 Metadata 儲存至 Elasticsearch 上。這邊的例子採用的是同一座 Ceph Cluster 並且以不同的 port 分配兩個 RGW(Radosgw) 並個別建立兩個 Zone 在同一個 Zonegroup 與 Realm 上。 安裝 Elasticsearch更新套件集1$ apt-get update 安裝 java1$ apt-get install openjdk-8-jdk -y 確認 java 環境是否正常12345$ java -versionopenjdk version &quot;1.8.0_191&quot;OpenJDK Runtime Environment (build 1.8.0_191-8u191-b12-2ubuntu0.16.04.1-b12)OpenJDK 64-Bit Server VM (build 25.191-b12, mixed mode) 下載並安裝 Elasticsearch 套件12$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.16.deb$ dpkg -i elasticsearch-5.6.16.deb 啟動 Elasticsearch 服務1$ systemctl start elasticsearch 編輯 Elasticsearch Configuration，將原先 network.host 註解移除並填入 0.0.0.0，以提供所有 IP Address 皆可進行存取。1234$ vim /etc/elasticsearch/elasticsearch.yml…network.host 0.0.0.0… 重新啟動 Elasticsearch 服務1$ systemctl restart elasticsearch 確認環境是否正常提供服務1234567891011121314$ curl 192.168.1.226:9200{ &quot;name&quot; : &quot;QNbZkhV&quot;, &quot;cluster_name&quot; : &quot;elasticsearch&quot;, &quot;cluster_uuid&quot; : &quot;MU9qYysiSLSDdpi-TXnWIw&quot;, &quot;version&quot; : { &quot;number&quot; : &quot;5.6.16&quot;, &quot;build_hash&quot; : &quot;3a740d1&quot;, &quot;build_date&quot; : &quot;2019-03-13T15:33:36.565Z&quot;, &quot;build_snapshot&quot; : false, &quot;lucene_version&quot; : &quot;6.6.1&quot; }, &quot;tagline&quot; : &quot;You Know, for Search&quot;} 注意：IP Address 記得更換為自己的 IP Address 建立 test-realm1234567$ radosgw-admin realm create --rgw-realm=test-realm --default{ &quot;id&quot;: &quot;96cf396e-796b-47e5-9ae2-2d59fb9e43df&quot;, &quot;name&quot;: &quot;test-realm&quot;, &quot;current_period&quot;: &quot;e1376cfd-1270-4e0f-bead-56a9cfbb1f8a&quot;, &quot;epoch&quot;: 1} 建立 test-zonegroup123456789101112131415$ radosgw-admin zonegroup create --rgw-realm=test-realm --rgw-zonegroup=test-zonegroup --endpoints=http://192.168.1.226:8001 --master --default{ &quot;id&quot;: &quot;ff420afa-3caa-4cdb-8e2e-595f8c0dc150&quot;, &quot;name&quot;: &quot;test-zonegroup&quot;, &quot;api_name&quot;: &quot;test-zonegroup&quot;, &quot;is_master&quot;: &quot;true&quot;, &quot;endpoints&quot;: [ &quot;http://192.168.1.226:8001&quot; ], &quot;hostnames&quot;: [], &quot;hostnames_s3website&quot;: [], &quot;master_zone&quot;: &quot;&quot;, &quot;zones&quot;: [], ...} 建立 test-zone-11234567891011121314$ radosgw-admin zone create --rgw-realm=test-realm --rgw-zonegroup=test-zonegroup --rgw-zone=test-zone --endpoints=http://192.168.1.226:8001 --access-key=test --secret=test --master --default{ ... &quot;placement_pools&quot;: [ { &quot;key&quot;: &quot;default-placement&quot;, &quot;val&quot;: { &quot;index_pool&quot;: &quot;test-zone.rgw.buckets.index&quot;, ... } } ], ...} 建立 test 使用者123456789101112131415$ radosgw-admin user create --uid=test --display-name=&quot;test&quot; --access-key=test --secret=test --system{ &quot;user_id&quot;: &quot;test&quot;, &quot;display_name&quot;: &quot;test&quot;, &quot;email&quot;: &quot;&quot;, ... &quot;keys&quot;: [ { &quot;user&quot;: &quot;test&quot;, &quot;access_key&quot;: &quot;test&quot;, &quot;secret_key&quot;: &quot;test&quot; } ], ...} 更新當前 Realm 底下數據123456789101112131415161718$ radosgw-admin period update --commit{ &quot;id&quot;: &quot;0d0783ec-c5c7-4e31-a1e5-ee9a81f9b08a&quot;, &quot;epoch&quot;: 1, ... &quot;period_map&quot;: { &quot;id&quot;: &quot;0d0783ec-c5c7-4e31-a1e5-ee9a81f9b08a&quot;, &quot;zonegroups&quot;: [ { &quot;id&quot;: &quot;ff420afa-3caa-4cdb-8e2e-595f8c0dc150&quot;, &quot;name&quot;: &quot;test-zonegroup&quot;, ... } ], ... }, ...} 編輯 Radosgw Configuration12345678910111213141516$ vim /etc/ceph/radosgw.conf[client.radosgw.gateway]mon_host = 192.168.1.226:6789keyring = /etc/ceph/ceph.client.radosgw.keyringlog file = /var/log/ceph/client.radosgw.test-zone-1.logrgw enable usage log = truergw_frontends = civetweb port=8001rgw_zone = test-zone[client.radosgw.gateway2]mon_host = 192.168.1.226:6789keyring = /etc/ceph/ceph.client.radosgw.keyringlog file = /var/log/ceph/client.radosgw.test-zone-2.logrgw enable usage log = truergw frontends = civetweb port=8002rgw_zone = test-zone-2 注意：需在 /etc/ceph/ceph.client.radosgw.keyring 中加入 client.radosgw.gateway2 的 key 啟動 client.radosgw.gateway1$ radosgw -n client.radosgw.gateway -c /etc/ceph/radosgw.conf 建立 test-zone-21234567891011$ radosgw-admin zone create --rgw-realm=test-realm --rgw-zonegroup=test-zonegroup --rgw-zone=test-zone-2 --access-key=test --secret=test --endpoints=http://192.168.1.226:8002{ &quot;id&quot;: &quot;d0a13b78-251b-4314-b026-722dfbe79ff1&quot;, &quot;name&quot;: &quot;test-zone-2&quot;, &quot;domain_root&quot;: &quot;test-zone-2.rgw.meta:root&quot;, &quot;control_pool&quot;: &quot;test-zone-2.rgw.control&quot;, &quot;gc_pool&quot;: &quot;test-zone-2.rgw.log:gc&quot;, &quot;lc_pool&quot;: &quot;test-zone-2.rgw.log:lc&quot;, &quot;log_pool&quot;: &quot;test-zone-2.rgw.log&quot;, ...} 修改 test-zone-2 的配置，更改 tier-type 與 tier-config 並指向 Elasticsearch 的 Port。12345678910111213$ radosgw-admin zone modify --rgw-realm=test-realm --rgw-zonegroup=test-zonegroup --rgw-zone=test-zone-2 --tier-type=elasticsearch --tier-config=endpoint=http://192.168.1.226:9200{ &quot;id&quot;: &quot;d0a13b78-251b-4314-b026-722dfbe79ff1&quot;, &quot;name&quot;: &quot;test-zone-2&quot;, &quot;domain_root&quot;: &quot;test-zone-2.rgw.meta:root&quot;, &quot;control_pool&quot;: &quot;test-zone-2.rgw.control&quot;, &quot;gc_pool&quot;: &quot;test-zone-2.rgw.log:gc&quot;, &quot;lc_pool&quot;: &quot;test-zone-2.rgw.log:lc&quot;, &quot;log_pool&quot;: &quot;test-zone-2.rgw.log&quot;, &quot;intent_log_pool&quot;: &quot;test-zone-2.rgw.log:intent&quot;, &quot;usage_log_pool&quot;: &quot;test-zone-2.rgw.log:usage&quot;, ...} 更新當前 Realm 底下數據123456789101112131415161718$ radosgw-admin period update --commit{ &quot;id&quot;: &quot;0d0783ec-c5c7-4e31-a1e5-ee9a81f9b08a&quot;, &quot;epoch&quot;: 2, ... &quot;period_map&quot;: { &quot;id&quot;: &quot;0d0783ec-c5c7-4e31-a1e5-ee9a81f9b08a&quot;, &quot;zonegroups&quot;: [ { &quot;id&quot;: &quot;ff420afa-3caa-4cdb-8e2e-595f8c0dc150&quot;, &quot;name&quot;: &quot;test-zonegroup&quot;, ... } ], ... }, ...} 啟動 client.radosgw.gateway21$ radosgw -n client.radosgw.gateway2 -c /etc/ceph/radosgw.conf 開啟瀏覽器輸入 192.168.1.226:8002 確認 Radosgw 服務正常 注意：Radosgw2 無法提供服務是正常的，因為若宣告 type 為 Elasticsearch 系統不會建立 bucket.data pool。 結果建立 Bucket 與上傳檔案，可利用 s3 api 或 s3 browser 進行測試。檢視 Pool 狀態可以發現 Radosgw2 系統沒有建立 bucket.data 1234567891011121314151617$ rados dfPOOL_NAME USED ….rgw.root 6.05KiB test-zone-2.rgw.buckets.index 0B test-zone-2.rgw.control 0B test-zone-2.rgw.log 5.07KiB test-zone-2.rgw.meta 0B test-zone.rgw.buckets.data 3B test-zone.rgw.buckets.index 0B test-zone.rgw.control 0B test-zone.rgw.log 0B test-zone.rgw.meta 663B total_objects 766total_used 4.22GiBtotal_avail 35.8GiBtotal_space 40.0GiB 可以看到 test-zone-2 因為宣告的 type 為 elasticsearch 因此不會建立 buckets.data。換句話說，使用者無法透過 RGW2 對 Ceph Object Storage 進行請求存取。 使用 Elasticsearch 查詢語法查詢 metadata12$ curl http://192.168.1.226:9200/_search?q=name:testTest1{&quot;took&quot;:10,&quot;timed_out&quot;:false,&quot;_shards&quot;:{&quot;total&quot;:26,&quot;successful&quot;:26,&quot;skipped&quot;:0,&quot;failed&quot;:0},&quot;hits&quot;:{&quot;total&quot;:1,&quot;max_score&quot;:0.6931472,&quot;hits&quot;:[{&quot;_index&quot;:&quot;rgw-test-realm-313b4db1&quot;,&quot;_type&quot;:&quot;object&quot;,&quot;_id&quot;:&quot;cf4bd9d8-eb23-4773-bd29-b5d640040f36.14828.2:testTest1:null&quot;,&quot;_score&quot;:0.6931472,&quot;_source&quot;:{&quot;bucket&quot;:&quot;bucket1&quot;,&quot;name&quot;:&quot;testTest1&quot;,&quot;instance&quot;:&quot;null&quot;,&quot;versioned_epoch&quot;:0,&quot;owner&quot;:{&quot;id&quot;:&quot;test&quot;,&quot;display_name&quot;:&quot;test&quot;},&quot;permissions&quot;:[&quot;test&quot;],&quot;meta&quot;:{&quot;size&quot;:550474,&quot;mtime&quot;:&quot;2019-03-20T09:07:47.272Z&quot;,&quot;etag&quot;:&quot;bf4fef418d8f1bb996200529e60bed00&quot;,&quot;tail_tag&quot;:&quot;cf4bd9d8-eb23-4773-bd29-b5d640040f36.14828.62968&quot;,&quot;x-amz-content-sha256&quot;:&quot;a4bb4653d3480dd8d5d58f76bca04dcc08e607bdb72b616b44feb980b3a387c6&quot;,&quot;x-amz-date&quot;:&quot;20190320T090745Z&quot;}}}]}} 注意：檔案名稱記得更換為自己所上傳的檔案名稱 參考 http://blog.umcloud.com/metasearch/ http://docs.ceph.com/docs/mimic/radosgw/elastic-sync-module/ https://ceph.com/rgw/new-luminous-rgw-metadata-search/","link":"/2019/03/25/Ceph-Object-Storage-Elasticsearch-實作快速搜尋-metadata/"}],"tags":[{"name":"Ceph","slug":"Ceph","link":"/tags/Ceph/"},{"name":"Object Storage","slug":"Object-Storage","link":"/tags/Object-Storage/"},{"name":"Elasticsearch","slug":"Elasticsearch","link":"/tags/Elasticsearch/"}],"categories":[{"name":"Ceph","slug":"Ceph","link":"/categories/Ceph/"},{"name":"Object Storage","slug":"Ceph/Object-Storage","link":"/categories/Ceph/Object-Storage/"},{"name":"Elasticsearch","slug":"Ceph/Object-Storage/Elasticsearch","link":"/categories/Ceph/Object-Storage/Elasticsearch/"}]}